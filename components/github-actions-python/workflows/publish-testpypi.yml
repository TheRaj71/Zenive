name: Publish to TestPyPI

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      version_suffix:
        description: 'Version suffix for test release (e.g., dev, alpha, beta)'
        required: false
        default: 'dev'
        type: string

jobs:
  validate-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get-version.outputs.version }}
      is-valid: ${{ steps.validate.outputs.is-valid }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version
        id: get-version
        run: |
          # Get base version from git tags or default
          BASE_VERSION=$(git describe --tags --abbrev=0 2>/dev/null | sed 's/^v//' || echo "0.1.0")
          
          # Create test version with timestamp and commit hash
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          COMMIT_HASH=$(git rev-parse --short HEAD)
          SUFFIX="${{ github.event.inputs.version_suffix || 'dev' }}"
          
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            PR_NUMBER="${{ github.event.number }}"
            VERSION="${BASE_VERSION}.${SUFFIX}${TIMESTAMP}.pr${PR_NUMBER}.${COMMIT_HASH}"
          else
            VERSION="${BASE_VERSION}.${SUFFIX}${TIMESTAMP}.${COMMIT_HASH}"
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Detected test version: $VERSION"

      - name: Validate version format
        id: validate
        run: |
          VERSION="${{ steps.get-version.outputs.version }}"
          
          if [ -z "$VERSION" ]; then
            echo "âŒ No version found"
            echo "is-valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # Check if version follows semantic versioning pattern (more lenient for test versions)
          if echo "$VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+'; then
            echo "âœ… Version format is valid: $VERSION"
            echo "is-valid=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Invalid version format: $VERSION"
            echo "is-valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi

  build:
    needs: validate-version
    if: needs.validate-version.outputs.is-valid == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build twine check-manifest

      - name: Update version for test release
        run: |
          VERSION="${{ needs.validate-version.outputs.version }}"
          
          # Update version in setup.py if it exists
          if [ -f setup.py ]; then
            sed -i "s/version=['\"][^'\"]*['\"]/version='$VERSION'/g" setup.py
          fi
          
          # Update version in pyproject.toml if it exists
          if [ -f pyproject.toml ]; then
            sed -i "s/version = ['\"][^'\"]*['\"]/version = \"$VERSION\"/g" pyproject.toml
          fi
          
          # Update version in __init__.py if it exists
          find . -name "__init__.py" -exec grep -l "__version__" {} \; | while read file; do
            sed -i "s/__version__ = ['\"][^'\"]*['\"]/__version__ = '$VERSION'/g" "$file"
          done
          
          echo "Updated version to: $VERSION"

      - name: Verify package manifest
        run: |
          check-manifest --verbose || echo "âš ï¸ Manifest check failed, continuing with build"

      - name: Build package
        run: |
          python -m build

      - name: Verify build artifacts
        run: |
          ls -la dist/
          
          # Check that both source and wheel distributions were created
          if [ ! -f dist/*.tar.gz ]; then
            echo "âŒ Source distribution not found"
            exit 1
          fi
          
          if [ ! -f dist/*.whl ]; then
            echo "âŒ Wheel distribution not found"
            exit 1
          fi
          
          echo "âœ… Build artifacts verified"

      - name: Check package with twine
        run: |
          twine check dist/*

      - name: Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: python-package-distributions-test
          path: dist/
          retention-days: 3

  test-install:
    needs: [validate-version, build]
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.8', '3.11', '3.12']  # Reduced matrix for faster testing
    steps:
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Download build artifacts
        uses: actions/download-artifact@v3
        with:
          name: python-package-distributions-test
          path: dist/

      - name: Test wheel installation
        run: |
          # Install the wheel package
          pip install dist/*.whl
          
          # Try to import the package (adjust package name as needed)
          python -c "
          import sys
          try:
              # Replace 'your_package' with actual package name
              import pkg_resources
              installed_packages = [d.project_name for d in pkg_resources.working_set]
              print('Installed packages:', installed_packages)
              print('âœ… Package installation test passed')
          except ImportError as e:
              print(f'âŒ Package import failed: {e}')
              sys.exit(1)
          "

  security-scan:
    needs: [validate-version, build]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Download build artifacts
        uses: actions/download-artifact@v3
        with:
          name: python-package-distributions-test
          path: dist/

      - name: Install security scanning tools
        run: |
          pip install safety bandit

      - name: Scan package for vulnerabilities
        run: |
          # Extract and scan the source distribution
          tar -xzf dist/*.tar.gz -C /tmp/
          EXTRACTED_DIR=$(find /tmp -maxdepth 1 -type d -name "*" | grep -v "^/tmp/$" | head -1)
          
          if [ -n "$EXTRACTED_DIR" ]; then
            echo "Scanning extracted package: $EXTRACTED_DIR"
            bandit -r "$EXTRACTED_DIR" -f json -o bandit-report.json || true
            
            # Check if any high severity issues were found (more lenient for test releases)
            if [ -f bandit-report.json ]; then
              HIGH_ISSUES=$(jq '.results[] | select(.issue_severity == "HIGH")' bandit-report.json | jq -s length)
              
              echo "Security scan results:"
              echo "- High severity issues: $HIGH_ISSUES"
              
              if [ "$HIGH_ISSUES" -gt 0 ]; then
                echo "âš ï¸ High severity security issues found in test release:"
                jq '.results[] | select(.issue_severity == "HIGH")' bandit-report.json
                echo "Continuing with TestPyPI publication for testing purposes"
              fi
            fi
          fi

  publish-testpypi:
    needs: [validate-version, build, test-install, security-scan]
    runs-on: ubuntu-latest
    environment: 
      name: testpypi
      url: https://test.pypi.org/project/${{ github.repository }}
    permissions:
      id-token: write  # Required for trusted publishing
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v3
        with:
          name: python-package-distributions-test
          path: dist/

      - name: Verify artifacts before publishing
        run: |
          echo "Files to be published to TestPyPI:"
          ls -la dist/
          
          # Final verification
          if [ $(ls dist/*.whl | wc -l) -ne 1 ]; then
            echo "âŒ Expected exactly one wheel file"
            exit 1
          fi
          
          if [ $(ls dist/*.tar.gz | wc -l) -ne 1 ]; then
            echo "âŒ Expected exactly one source distribution"
            exit 1
          fi
          
          echo "âœ… Artifacts verified for TestPyPI publishing"

      - name: Publish to TestPyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          repository-url: https://test.pypi.org/legacy/
          print-hash: true
          verbose: true

      - name: Test installation from TestPyPI
        run: |
          # Wait a moment for the package to be available
          sleep 30
          
          # Try to install from TestPyPI
          VERSION="${{ needs.validate-version.outputs.version }}"
          PACKAGE_NAME=$(basename ${{ github.repository }})
          
          echo "Testing installation from TestPyPI..."
          pip install --index-url https://test.pypi.org/simple/ --extra-index-url https://pypi.org/simple/ "${PACKAGE_NAME}==${VERSION}" || {
            echo "âš ï¸ Installation from TestPyPI failed - this is common for test releases"
            echo "Package may still be processing or have dependency issues in test environment"
          }

      - name: Create summary comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const version = "${{ needs.validate-version.outputs.version }}";
            const packageName = "${{ github.repository }}".split('/')[1];
            const body = `ðŸ§ª **Test package published to TestPyPI!**
            
            **Version:** \`${version}\`
            **TestPyPI URL:** https://test.pypi.org/project/${packageName}/
            **Test install command:** 
            \`\`\`bash
            pip install --index-url https://test.pypi.org/simple/ --extra-index-url https://pypi.org/simple/ ${packageName}==${version}
            \`\`\`
            
            âš ï¸ **Note:** This is a test release for validation purposes only.
            Test packages may have dependency resolution issues and should not be used in production.`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Create workflow summary
        run: |
          VERSION="${{ needs.validate-version.outputs.version }}"
          PACKAGE_NAME=$(basename ${{ github.repository }})
          
          cat >> $GITHUB_STEP_SUMMARY << EOF
          # ðŸ§ª TestPyPI Publication Summary
          
          **Package:** \`${PACKAGE_NAME}\`
          **Version:** \`${VERSION}\`
          **TestPyPI URL:** https://test.pypi.org/project/${PACKAGE_NAME}/
          
          ## Test Installation
          \`\`\`bash
          pip install --index-url https://test.pypi.org/simple/ --extra-index-url https://pypi.org/simple/ ${PACKAGE_NAME}==${VERSION}
          \`\`\`
          
          ## Next Steps
          - Verify the test package works as expected
          - If satisfied, create a release to publish to production PyPI
          - Test packages are automatically cleaned up after a few days
          EOF